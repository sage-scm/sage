#!/usr/bin/env bash
set -euo pipefail

COMMIT_MSG_FILE=$1
COMMIT_SOURCE=${2:-}
SHA1=${3:-}

# Skip if message was provided (not empty commit)
if [ -z "${COMMIT_SOURCE:-}" ]; then
    # Check if we're in a specific type of directory that might need prefixes
    current_dir=$(pwd)

    # Add branch name to commit if on a feature branch
    branch_name=$(git branch --show-current)

    # Skip for main/master branches
    if [[ "$branch_name" != "main" && "$branch_name" != "master" ]]; then
        # Extract potential ticket/issue number from branch name
        # e.g., feature/PFS-1234-add-something -> PFS-1234
        ticket=$(echo "$branch_name" | grep -oE '[A-Z]+-[0-9]+' | head -1 || true)

        if [ -n "$ticket" ]; then
            # Check if ticket reference already exists in message
            if ! grep -q "$ticket" "$COMMIT_MSG_FILE"; then
                # Append ticket reference to the commit message
                echo "" >> "$COMMIT_MSG_FILE"
                echo "Refs: $ticket" >> "$COMMIT_MSG_FILE"
            fi
        fi
    fi
fi
